<!doctype html><html xmlns=http://www.w3.org/1999/xhtml><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Crafting your own vagrant-lxc base box | fabiorehm.com</title><meta property="og:title" content="Crafting your own vagrant-lxc base box - fabiorehm.com"><meta property="og:description" content="How to build your own vagrant-lxc base boxes"><meta property="og:url" content="https://fabiorehm.com/blog/2013/07/18/crafting-your-own-vagrant-lxc-base-box/"><meta property="og:site_name" content="fabiorehm.com"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/2b78c6da27ec7e1419eebc8b683c25a3?s=256"><meta property="article:section" content="Blog"><meta property="article:tag" content="vagrant"><meta property="article:tag" content="vagrant-lxc"><meta property="article:tag" content="lxc"><meta property="article:tag" content="linux containers"><meta property="article:published_time" content="2013-07-18T00:00:00Z"><meta property="article:modified_time" content="2013-07-18T00:00:00Z"><meta name=twitter:card content="summary"><meta name=twitter:site content="@fgrehm"><meta name=twitter:creator content="@fgrehm"><link href=https://fabiorehm.com/index.xml rel=alternate type=application/rss+xml title=fabiorehm.com><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://fabiorehm.com/css/site.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://fabiorehm.com/blog/2013/07/18/crafting-your-own-vagrant-lxc-base-box/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://fabiorehm.com/><h1 id=nav-heading class="title is-4">fabiorehm.com</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=email href=mailto:site@fabiorehm.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=github href=https://github.com/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=twitter href=https://twitter.com/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922H1.468748v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a><a class=level-item aria-label=rss href=/index.xml target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/vagrant/>#vagrant</a>
| <a class="subtitle is-6" href=/tags/vagrant-lxc/>#vagrant-lxc</a>
| <a class="subtitle is-6" href=/tags/lxc/>#lxc</a>
| <a class="subtitle is-6" href=/tags/linux-containers/>#linux containers</a></div><h2 class="subtitle is-6">July 18, 2013</h2><h1 class=title>Crafting your own vagrant-lxc base box</h1><div class=content><p>As I <a href=/blog/2013/06/10/improving-vagrant-lxc-boxes/>said before</a>, &ldquo;next generation&rdquo;
<a href=https://github.com/fgrehm/vagrant-lxc>vagrant-lxc</a> boxes should simplify the process
of &ldquo;promoting&rdquo; existing containers to base boxes. To back that up I&rsquo;ve wrote
a detailed step-by-step for creating an Ubuntu Precise and Debian Squeeze base boxes
from an Ubuntu Host and I&rsquo;m pretty sure it is possible to reuse the ideas from this
post to build base boxes for / from other distros that suits everyone&rsquo;s needs.</p><p>I&rsquo;ve followed the steps on an Ubuntu 12.10 VirtualBox VM and if you want to follow
along you might want to grab yourself a copy of the same <a href=https://gist.github.com/fgrehm/b07c6370a710be622807#file-ubuntu-host-rb>Vagrantfile</a>
I used and fire it up with <code>vagrant up --provider=virtualbox</code>. I&rsquo;m also assuming
that you&rsquo;ll follow each step within the same shell session as we&rsquo;ll be reusing
some variables between steps.</p><p><em>If you want a &ldquo;copy & paste version&rdquo; of this post check this <a href=https://gist.github.com/fgrehm/6034400>gist</a>
out</em></p><h2 id=bootstrapping-the-guest-container-rootfs>Bootstrapping the guest container rootfs
<a href=#bootstrapping-the-guest-container-rootfs><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>The first thing we&rsquo;ll do is create the base container with <code>lxc-create</code> with
<a href=https://github.com/lxc/lxc/tree/staging/templates>vanilla templates</a>, for
Ubuntu guests that means:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>RELEASE<span style=color:#f92672>=</span>precise
</span></span><span style=display:flex><span>ARCH<span style=color:#f92672>=</span>amd64
</span></span><span style=display:flex><span>sudo lxc-create -n <span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>-base -t ubuntu -- --release <span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span> --arch <span style=color:#e6db74>${</span>ARCH<span style=color:#e6db74>}</span></span></span></code></pre></div><p>And for Debian guests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SUITE<span style=color:#f92672>=</span>squeeze
</span></span><span style=display:flex><span>RELEASE<span style=color:#f92672>=</span>$SUITE
</span></span><span style=display:flex><span>sudo lxc-create -n <span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>-base -t debian</span></span></code></pre></div><p><em>Before you ask, I decided to set both a <code>SUITE</code> and a <code>RELEASE</code> variables because
the debian template <a href=https://github.com/lxc/lxc/blob/staging/templates/lxc-debian.in#L23>expects</a>
a <code>SUITE</code> env var to specify the release version and we&rsquo;ll be referencing it
by just <code>$RELEASE</code> on the rest of the post to make things easier :)</em></p><p>If you want to know more about the parameters a template accepts, try running
<code>lxc-create -t &lt;template-name> -- --help</code> or look into the scripts at <code>/usr/share/lxc/templates</code>.</p><p>To finish up this initial setup, some aditional steps are required to make sure
the Debian containers will get to play well with Vagrant / vagrant-lxc:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rootfs<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/lib/lxc/</span><span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span><span style=color:#e6db74>-base/rootfs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># This fixes some networking issues</span>
</span></span><span style=display:flex><span><span style=color:#75715e># See https://github.com/fgrehm/vagrant-lxc/issues/91 for more info</span>
</span></span><span style=display:flex><span>sudo sed -i -e <span style=color:#e6db74>&#34;s/\(127.0.0.1\s\+localhost\)/\1\n127.0.1.1\t</span><span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span><span style=color:#e6db74>-base\n/g&#34;</span> <span style=color:#e6db74>${</span>rootfs<span style=color:#e6db74>}</span>/etc/hosts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># This ensures that `/tmp` does not get cleared on halt</span>
</span></span><span style=display:flex><span><span style=color:#75715e># See https://github.com/fgrehm/vagrant-lxc/issues/68 for more info</span>
</span></span><span style=display:flex><span>sudo chroot $rootfs /usr/sbin/update-rc.d -f checkroot-bootclean.sh remove
</span></span><span style=display:flex><span>sudo chroot $rootfs /usr/sbin/update-rc.d -f mountall-bootclean.sh remove
</span></span><span style=display:flex><span>sudo chroot $rootfs /usr/sbin/update-rc.d -f mountnfs-bootclean.sh remove</span></span></code></pre></div><h2 id=configure-the-vagrant-user>Configure the vagrant user
<a href=#configure-the-vagrant-user><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>The Ubuntu template <a href=https://github.com/lxc/lxc/blob/staging/templates/lxc-ubuntu.in#L79-L80>creates</a>
an <code>ubuntu</code> user by default and we&rsquo;ll just rename it to <code>vagrant</code> in order to
avoid the need to specify <a href=http://docs.vagrantup.com/v2/vagrantfile/ssh_settings.html>Vagrant&rsquo;s</a>
<code>config.default.username</code> on our Vagrantfiles:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ROOTFS<span style=color:#f92672>=</span>/var/lib/lxc/<span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>-base/rootfs
</span></span><span style=display:flex><span>sudo chroot <span style=color:#e6db74>${</span>ROOTFS<span style=color:#e6db74>}</span> usermod -l vagrant -d /home/vagrant ubuntu</span></span></code></pre></div><p>The Debian template does not create any user so we&rsquo;ll just add it with <code>adduser</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ROOTFS<span style=color:#f92672>=</span>/var/lib/lxc/<span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>-base/rootfs
</span></span><span style=display:flex><span>sudo chroot <span style=color:#e6db74>${</span>ROOTFS<span style=color:#e6db74>}</span> useradd --create-home -s /bin/bash vagrant</span></span></code></pre></div><p>At this point it is a good idea to set <code>vagrant</code> as the password too since most
boxes I&rsquo;ve used had this set up like that. The following applies to both Debian
and Ubuntu guests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo -n <span style=color:#e6db74>&#39;vagrant:vagrant&#39;</span> | sudo chroot <span style=color:#e6db74>${</span>ROOTFS<span style=color:#e6db74>}</span> chpasswd</span></span></code></pre></div><h3 id=set-up-ssh-access-and-passwordless-sudo>Set up SSH access and passwordless <code>sudo</code>
<a href=#set-up-ssh-access-and-passwordless-sudo><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>The steps above ensures the <code>vagrant</code> user exists, but we still need to set up
SSH access by allowing connections using the <a href=https://github.com/mitchellh/vagrant/blob/master/keys/vagrant.pub>default Vagrant SSH key</a>
and also <a href=http://docs-v1.vagrantup.com/v1/docs/base_boxes.html>enable passwordless <code>sudo</code></a>
for things to work properly.</p><p>Before we get to that, make sure that <code>sudo</code> is installed on Debian guests and
that the <code>vagrant</code> user belongs to the <code>sudo</code> group by running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo chroot <span style=color:#e6db74>${</span>ROOTFS<span style=color:#e6db74>}</span> apt-get install sudo -y --force-yes
</span></span><span style=display:flex><span>sudo chroot <span style=color:#e6db74>${</span>ROOTFS<span style=color:#e6db74>}</span> adduser vagrant sudo</span></span></code></pre></div><p>If everything went fine, you should now be able to run the commands
below to set up SSH access and enable passwordless <code>sudo</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Configure SSH access</span>
</span></span><span style=display:flex><span>sudo mkdir -p <span style=color:#e6db74>${</span>ROOTFS<span style=color:#e6db74>}</span>/home/vagrant/.ssh
</span></span><span style=display:flex><span>sudo wget https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub -O <span style=color:#e6db74>${</span>ROOTFS<span style=color:#e6db74>}</span>/home/vagrant/.ssh/authorized_keys
</span></span><span style=display:flex><span>sudo chroot <span style=color:#e6db74>${</span>ROOTFS<span style=color:#e6db74>}</span> chown -R vagrant:vagrant /home/vagrant/.ssh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Enable passwordless sudo for users under the &#34;sudo&#34; group</span>
</span></span><span style=display:flex><span>sudo cp <span style=color:#e6db74>${</span>ROOTFS<span style=color:#e6db74>}</span>/etc/sudoers<span style=color:#f92672>{</span>,.orig<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo sed -i -e <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      <span style=color:#e6db74>&#39;s/%sudo\s\+ALL=(ALL\(:ALL\)\?)\s\+ALL/%sudo ALL=NOPASSWD:ALL/g&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      <span style=color:#e6db74>${</span>ROOTFS<span style=color:#e6db74>}</span>/etc/sudoers</span></span></code></pre></div><p>This is basically enough for us to <a href=#build_box_package>export the container&rsquo;s rootfs and prepare
the vagrant-lxc box</a> but the container is pretty dumb rough
and we can do some work to make it a better place :)</p><h2 id=add-yourstuff-to-the-base-container>Add YourStuffâ„¢ to the base container
<a href=#add-yourstuff-to-the-base-container><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>After the guest container has been created, bring it up with
<code>sudo lxc-start -n ${RELEASE}-base</code> and log in using <code>vagrant</code> as both the user
and password, once you are logged into the container you can do whatever you
want with it. Below you&rsquo;ll find some things that I found useful when building
the current vagrant-lxc boxes.</p><p><em>Please note that all of the code below is meant to be run from inside the container</em></p><h3 id=avoid-certificate-warnings-when-installing-packages-on-debian-guests>Avoid certificate warnings when installing packages on Debian guests
<a href=#avoid-certificate-warnings-when-installing-packages-on-debian-guests><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>If you try to install some package on the container you&rsquo;ll notice that a warning
shows up saying that the packages cannot be authenticated. In order to make it go
away you&rsquo;ll need to install the <code>ca-certificates</code> package and run a <code>apt-get update</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get install -y --force-yes ca-certificates
</span></span><span style=display:flex><span>sudo apt-get update</span></span></code></pre></div><h3 id=add-some-basic-packages>Add some basic packages
<a href=#add-some-basic-packages><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>Make your container a better place and install some &ldquo;must-have&rdquo; packages:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PACKAGES<span style=color:#f92672>=(</span>vim curl wget manpages bash-completion<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>sudo apt-get install <span style=color:#e6db74>${</span>PACKAGES[*]<span style=color:#e6db74>}</span> -y --force-yes</span></span></code></pre></div><h3 id=install-chef>Install Chef
<a href=#install-chef><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>If you want to have <a href=http://www.opscode.com/chef/>Chef</a> pre installed on the
base box, you can run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L https://www.opscode.com/chef/install.sh -k | sudo bash</span></span></code></pre></div><h3 id=install-puppet>Install Puppet
<a href=#install-puppet><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>If you want to have <a href=https://puppetlabs.com/>Puppet</a> pre installed on the base
box, you can run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget http://apt.puppetlabs.com/puppetlabs-release-stable.deb -O <span style=color:#e6db74>&#34;/tmp/puppetlabs-release-stable.deb&#34;</span>
</span></span><span style=display:flex><span>dpkg -i <span style=color:#e6db74>&#34;/tmp/puppetlabs-release-stable.deb&#34;</span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install puppet -y --force-yes</span></span></code></pre></div><h3 id=free-up-some-disk-space>Free up some disk space
<a href=#free-up-some-disk-space><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>When you are done configuring the container, make sure you run the code below from
within the container to reduce the rootfs / box size:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo rm -rf /tmp/*
</span></span><span style=display:flex><span>sudo apt-get clean</span></span></code></pre></div><h2 id=build-box-package>Build box package
<a href=#build-box-package><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>After configuring the container, shut it down by running <code>sudo halt</code> and follow
the steps below from the host to build the <code>.box</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Set up a working dir</span>
</span></span><span style=display:flex><span>mkdir -p /tmp/vagrant-lxc-<span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Compress container&#39;s rootfs</span>
</span></span><span style=display:flex><span>cd /var/lib/lxc/<span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>-base
</span></span><span style=display:flex><span>sudo tar --numeric-owner -czf /tmp/vagrant-lxc-<span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>/rootfs.tar.gz ./rootfs/*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Prepare package contents</span>
</span></span><span style=display:flex><span>cd /tmp/vagrant-lxc-<span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>sudo chown $USER:<span style=color:#e6db74>`</span>id -gn<span style=color:#e6db74>`</span> rootfs.tar.gz
</span></span><span style=display:flex><span>wget https://raw.github.com/fgrehm/vagrant-lxc/master/boxes/common/lxc-template
</span></span><span style=display:flex><span>wget https://raw.github.com/fgrehm/vagrant-lxc/master/boxes/common/lxc.conf
</span></span><span style=display:flex><span>wget https://raw.github.com/fgrehm/vagrant-lxc/master/boxes/common/metadata.json
</span></span><span style=display:flex><span>chmod +x lxc-template
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Vagrant box!</span>
</span></span><span style=display:flex><span>tar -czf vagrant-lxc-<span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>.box ./*</span></span></code></pre></div><h2 id=try-it-out>Try it out
<a href=#try-it-out><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>To make sure you are able to use the container with vagrant-lxc, try importing
the base box and bring it up with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/test-import <span style=color:#f92672>&amp;&amp;</span> cd /tmp/test-import
</span></span><span style=display:flex><span>vagrant init my-box /tmp/vagrant-lxc-<span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>/vagrant-lxc-<span style=color:#e6db74>${</span>RELEASE<span style=color:#e6db74>}</span>.box
</span></span><span style=display:flex><span>vagrant up --provider<span style=color:#f92672>=</span>lxc</span></span></code></pre></div><p>If everything went fine, you should be able to SSH into it with <code>vagrant ssh</code>
without issues.</p><p>When you are done with the base container, make sure you destroy it using
<code>sudo lxc-destroy -n ${RELEASE}-base</code> to free up some disc space.</p><h2 id=coming-up>Coming up
<a href=#coming-up><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>Over the following weeks I&rsquo;ll be going through the process of using this approach
to build the &ldquo;official&rdquo; Ubuntu base boxes instead of some hand made <a href=https://github.com/fgrehm/vagrant-lxc/blob/master/tasks>Rake task</a>
and <a href=https://github.com/fgrehm/vagrant-lxc/tree/master/boxes>bash scripts</a>. One of
the good things about following this approach is that because the built-in Ubuntu
template keeps a <a href=https://github.com/lxc/lxc/blob/staging/templates/lxc-ubuntu.in#L340-L345>rootfs cache</a>
around, which means that the base container creation time gets a lot lower and
I&rsquo;m able to iterate over new base boxes a lot faster. After this is proven to work,
I&rsquo;ll try to get my head around <a href=http://golang.org/>Go</a> and will look into adding
support for building lxc root file systems for <a href=http://www.packer.io/>Packer</a>.</p><p>That&rsquo;s it! I hope this opens up for others to fill in <a href=https://github.com/fgrehm/vagrant-lxc/wiki/Base-boxes>the Wiki</a>
with instructions for building other distros and <a href=http://www.vagrantbox.es/>http://www.vagrantbox.es/</a>
with pre built boxes :)</p><div class=related><h3>Similar articles:</h3><ul><li><a href=/blog/2013/06/10/improving-vagrant-lxc-boxes/>Improving vagrant-lxc boxes</a></li><li><a href=/blog/2013/04/28/lxc-provider-for-vagrant/>LXC provider for Vagrant</a></li><li><a href=/blog/2013/07/15/vundler-dead-easy-plugin-management-for-vagrant/>Vundler: Dead easy plugin management for Vagrant</a></li><li><a href=/blog/2013/05/24/stop-wasting-bandwidth-with-vagrant-cachier/>Stop wasting bandwidth with vagrant-cachier</a></li><li><a href=/blog/2013/01/22/announcing-letter_opener_web-1-0/>Announcing letter_opener_web 1.0</a></li></ul></div></div></div></section><script src=/js/copycode.js></script><section class=section><div class=container><aside><div id=disqus_thread></div></aside><div id=show_comments><a id=load_comments class="button is-link">Load comments</a></div><script type=text/javascript>var disqus_shortname="fgrehm",hash;function disqus(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}hash=window.location.hash.substr(1),hash.length>8&&hash.substring(0,8)==="comment-"?(disqus(),document.getElementById("show_comments").style.display="none"):document.getElementById("load_comments").onclick=function(){disqus(),document.getElementById("show_comments").style.display="none"}</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p>&copy; <a href=https://github.com/fgrehm>Fabio Rehm</a> 2013-2022</p><p>Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/ribice/kiss>Kiss</a>.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z78MGSF72P"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z78MGSF72P",{anonymize_ip:!1})}</script></body></html>