<!doctype html><html xmlns=http://www.w3.org/1999/xhtml><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Stop wasting bandwidth with vagrant-cachier | fabiorehm.com</title><meta property="og:title" content="Stop wasting bandwidth with vagrant-cachier - fabiorehm.com"><meta property="og:description" content="Reduce Vagrant provisioning time with a local cache"><meta property="og:url" content="https://fabiorehm.com/blog/2013/05/24/stop-wasting-bandwidth-with-vagrant-cachier/"><meta property="og:site_name" content="fabiorehm.com"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/2b78c6da27ec7e1419eebc8b683c25a3?s=256"><meta property="article:section" content="Blog"><meta property="article:tag" content="vagrant"><meta property="article:tag" content="cache"><meta property="article:tag" content="apt"><meta property="article:tag" content="yum"><meta property="article:tag" content="pacman"><meta property="article:tag" content="rubygems"><meta property="article:tag" content="gems"><meta property="article:published_time" content="2013-05-24T00:00:00Z"><meta property="article:modified_time" content="2013-05-24T00:00:00Z"><meta name=twitter:card content="summary"><meta name=twitter:site content="@fgrehm"><meta name=twitter:creator content="@fgrehm"><link href=https://fabiorehm.com/index.xml rel=alternate type=application/rss+xml title=fabiorehm.com><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://fabiorehm.com/css/site.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://fabiorehm.com/blog/2013/05/24/stop-wasting-bandwidth-with-vagrant-cachier/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://fabiorehm.com/><h1 id=nav-heading class="title is-4">fabiorehm.com</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=email href=mailto:site@fabiorehm.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=github href=https://github.com/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=twitter href=https://twitter.com/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922H1.468748v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a><a class=level-item aria-label=rss href=/index.xml target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/vagrant/>#vagrant</a>
| <a class="subtitle is-6" href=/tags/cache/>#cache</a>
| <a class="subtitle is-6" href=/tags/apt/>#apt</a>
| <a class="subtitle is-6" href=/tags/yum/>#yum</a>
| <a class="subtitle is-6" href=/tags/pacman/>#pacman</a>
| <a class="subtitle is-6" href=/tags/rubygems/>#rubygems</a>
| <a class="subtitle is-6" href=/tags/gems/>#gems</a></div><h2 class="subtitle is-6">May 24, 2013</h2><h1 class=title>Stop wasting bandwidth with vagrant-cachier</h1><div class=content><p>If you have done any kind of Puppet manifests / Chef cookbooks development using
Vagrant chances are that you&rsquo;ve been staring at your screen waiting for the machine
to be provisioned for really long periods of time, specially when you need to
destroy the VM and start over.</p><p>A while ago I came across this <a href=http://gist.github.com/juanje/3797297>gist</a> which
solves part of the issue by caching downloaded packages on the host machine and
sharing them among similar VM instances. After copying and pasting it on different
projects, I decided to extract it to a Vagrant plugin and expand its usage by
supporting multiple Linux distros and package managers allowing others to benefit
from it as well.</p><p>I started spiking the plugin a while ago and after using it on a couple projects
today I went ahead and <a href=https://github.com/fgrehm/vagrant-cachier>open sourced it</a>.
The code is not the best you&rsquo;ll find around and right now it supports caching for
APT, Yum, Pacman and RubyGems packages and I&rsquo;m planning to add others as needed.</p><p>On a side note, this is probably the first Vagrant plugin to make use of
<a href=http://docs.vagrantup.com/v2/plugins/guest-capabilities.html>guest capabilities</a>
that I&rsquo;m aware of ;)</p><h2 id=how-does-it-work>How does it work?
<a href=#how-does-it-work><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>From the project&rsquo;s <a href=https://github.com/fgrehm/vagrant-cachier/blob/master/README.md>README</a>:</p><blockquote><p>Under the hood, the plugin will hook into calls to <code>Vagrant::Builtin::Provision</code> during <code>vagrant up</code> / <code>vagrant reload</code> and will set things up for each configured cache bucket. Before halting the machine, it will revert the changes required to set things up by hooking into calls to <code>Vagrant::Builtin::GracefulHalt</code> so that you can repackage the machine for others to use without requiring users to install the plugin as well.</p><p>Cache buckets will be available from <code>/tmp/vagrant-cachier</code> on your guest and the appropriate folders will get symlinked to the right path <em>after</em> the machine is up but <em>right before</em> it gets provisioned. We <em>could</em> potentially do it on one go and share bucket&rsquo;s folders directly to the right path if we were only using VirtualBox since it shares folders <em>after</em> booting the machine, but the LXC provider does that <em>as part of</em> the boot process (shared folders are actually <code>lxc-start</code> parameters) and as of now we are not able to get some information that this plugin requires about the guest machine before it is actually up and running.</p><p>Please keep in mind that this plugin won&rsquo;t do magic, if you are compiling things during provisioning or manually downloading packages that does not fit into a &ldquo;cache bucket&rdquo; you won&rsquo;t see that much of improvement.</p></blockquote><p><em><strong>UPDATE</strong>: Please refer to the project&rsquo;s <a href=http://fgrehm.viewdocs.io/vagrant-cachier/how-does-it-work>docs</a>
for the most up-to-date information about it. Things have changed a bit lately and are
likely to change a bit more ;)</em></p><h2 id=show-me-the-numbers>Show me the numbers!
<a href=#show-me-the-numbers><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>I&rsquo;ve done some pretty basic testing on four different boxes doing something along
the lines of <a href=https://gist.github.com/fgrehm/1b4025f65a66bdbccc12>this script</a>
on VirtualBox VMs with <a href=/blog/2013/01/17/100-percent-on-vagrant/#enable_nfs>NFS</a>
and <a href=https://github.com/fgrehm/vagrant-cachier#cache-scope>machine cache scope</a>
enabled:</p><ul><li>vagrant-lxc&rsquo;s Ubuntu 12.10 <a href=https://github.com/fgrehm/vagrant-lxc#using-virtualbox-for-development>dev box</a></li><li><a href=https://github.com/rails/rails-dev-box>rails-dev-box</a></li><li>My own <a href=https://github.com/fgrehm/rails-base-box>rails-base-box</a></li><li>Discourse&rsquo;s <a href=https://github.com/discourse/discourse/blob/master/Vagrantfile>dev box</a></li></ul><p>The times shown below are just for provisioning after the machine has already been
brought up on a 35mb connection:</p><table><thead><tr><th></th><th>First provision</th><th>Second provision</th><th>Diff.</th><th>APT cache</th></tr></thead><tbody><tr><td>rails-dev-box</td><td>4m45s</td><td>3m20s</td><td>~29%</td><td>66mb</td></tr><tr><td>rails-base-box</td><td>11m56s</td><td>7m54s</td><td>~34%</td><td>77mb</td></tr><tr><td>vagrant-lxc</td><td>10m16s</td><td>5m9s</td><td>~50%</td><td>124mb</td></tr><tr><td>discourse</td><td>1m41s</td><td>49s</td><td>~51%</td><td>62mb</td></tr></tbody></table><p>As I said, the plugin does not do any magic and it will just save you from downloading
packages. For instance, my rails-base-box compiles Ruby 2.0 from source using <a href=https://github.com/sstephenson/ruby-build>ruby-build</a>
and there&rsquo;s nothing much we can do about it (apart from using precompiled rubies of course).</p><p>If you do the maths, on average those numbers represents <code>~41%</code> drop on provisioning time.
In my opinion this alone represents a huge win, specially if you are running
a CI server as it means a faster feedback loop. It also means that if a mirror is slower
that usual for some weird reason or if you are on a 3G connection, it&rsquo;ll save you a few mbs
worth of downloading packages. Not to say that is &ldquo;<a href=https://github.com/sstephenson/ruby-build/pull/232>against etiquette towards package hosters</a>&rdquo;
to download those files over and over throughout the day.</p><p>So please, be nice and stop wasting yours and others bandwidth :)</p><h2 id=update>UPDATE
<a href=#update><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>I&rsquo;ve been stalking <a href="https://twitter.com/search?q=vagrant%20cachier">watching</a>
what people have been saying about the plugin on twitter and looks like some have
experienced an even bigger drop on provisioning time:</p><div class=related><h3>Similar articles:</h3><ul><li><a href=/blog/2013/04/28/lxc-provider-for-vagrant/>LXC provider for Vagrant</a></li><li><a href=/blog/2013/01/22/announcing-letter_opener_web-1-0/>Announcing letter_opener_web 1.0</a></li><li><a href=/blog/2013/01/17/100-percent-on-vagrant/>100% on Vagrant</a></li></ul></div></div></div></section><section class=section><div class=container><aside><div id=disqus_thread></div></aside><div id=show_comments><a id=load_comments class="button is-link">Load comments</a></div><script type=text/javascript>var disqus_shortname="fgrehm",hash;function disqus(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}hash=window.location.hash.substr(1),hash.length>8&&hash.substring(0,8)==="comment-"?(disqus(),document.getElementById("show_comments").style.display="none"):document.getElementById("load_comments").onclick=function(){disqus(),document.getElementById("show_comments").style.display="none"}</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p>&copy; <a href=https://github.com/fgrehm>Fabio Rehm</a> 2013-2022</p><p>Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/ribice/kiss>Kiss</a>.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z78MGSF72P"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z78MGSF72P",{anonymize_ip:!1})}</script></body></html>