<!doctype html><html xmlns=http://www.w3.org/1999/xhtml><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Sharing Chef Cookbooks | fabiorehm.com</title><meta property="og:title" content="Sharing Chef Cookbooks - fabiorehm.com"><meta property="og:description" content="My journey on setting things up to push chef-dokku to Opscode Community"><meta property="og:url" content="https://fabiorehm.com/blog/2013/10/01/sharing-chef-cookbooks/"><meta property="og:site_name" content="fabiorehm.com"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/2b78c6da27ec7e1419eebc8b683c25a3?s=256"><meta property="article:section" content="Blog"><meta property="article:tag" content="chef"><meta property="article:tag" content="cookbook"><meta property="article:tag" content="dokku"><meta property="article:tag" content="devops"><meta property="article:published_time" content="2013-10-01T00:00:00Z"><meta property="article:modified_time" content="2013-10-01T00:00:00Z"><meta name=twitter:card content="summary"><meta name=twitter:site content="@fgrehm"><meta name=twitter:creator content="@fgrehm"><link href=https://fabiorehm.com/index.xml rel=alternate type=application/rss+xml title=fabiorehm.com><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://fabiorehm.com/css/site.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://fabiorehm.com/blog/2013/10/01/sharing-chef-cookbooks/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://fabiorehm.com/><h1 id=nav-heading class="title is-4">fabiorehm.com</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=email href=mailto:site@fabiorehm.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=github href=https://github.com/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=twitter href=https://twitter.com/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922H1.468748v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a><a class=level-item aria-label=rss href=/index.xml target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/chef/>#chef</a>
| <a class="subtitle is-6" href=/tags/cookbook/>#cookbook</a>
| <a class="subtitle is-6" href=/tags/dokku/>#dokku</a>
| <a class="subtitle is-6" href=/tags/devops/>#devops</a></div><h2 class="subtitle is-6">October 1, 2013</h2><h1 class=title>Sharing Chef Cookbooks</h1><div class=content><p>I&rsquo;ve been trying to publish my <a href=https://github.com/progrium/dokku>Dokku</a> Cookbook
to <a href=http://www.opscode.com/community/>Opscode Community</a> since I <a href=https://github.com/fgrehm/chef-dokku>open sourced it</a>
a couple weeks ago but didn&rsquo;t have much success until last night. The initial
configuration was not so straightforward to me so I thought I&rsquo;d write it down
in case I need to do it again. The information on this post is probably documented
somewhere but I failed to find it, feel free to comment with links to official docs
or other blog posts related :)</p><p><a href=https://github.com/fgrehm/chef-dokku>chef-dokku</a> is the result of my initial
interaction with <a href=http://www.opscode.com/chef/>Chef</a> which I&rsquo;ve been using as
part of another project which I plan to release &ldquo;soon&rdquo;. It allows you to manage
a Dokku installation, allowing configuration of application&rsquo;s <a href=https://github.com/progrium/dokku#environment-setup>environment variables</a>
and installation of <a href=https://github.com/progrium/dokku/wiki/Plugins>Dokku plugins</a>.</p><p>Since I come from a <a href=http://puppetlabs.com/puppet/what-is-puppet>Puppet</a> background,
I had no idea what to do in order to publish the Cookbook to Opscode Community.
Thanks to <a href=https://twitter.com/juanjeojeda/status/376398727822340096>@juanjeojeda</a>
I got to know the command used for publishing but sadly that wasn&rsquo;t enough to
make it work.</p><p>I&rsquo;ve been using the plugin from within Vagrant machines only and didn&rsquo;t have the
<a href=http://docs.opscode.com/knife.html><code>knife</code></a> command available on my laptop so
first thing I had to do was a <code>gem install chef</code> to get <code>knife</code> around. With Chef
installed, my first attempt was to run the command Juanje suggested from a clean
<code>git clone</code> but had no luck:</p><p>It turns out that <code>knife</code> <a href=http://starkandwayne.com/articles/2013/05/07/tdd-your-devops-with-test-kitchen/#sharing_the_cookbook>doesn&rsquo;t like the chef-dokku folder name and you need to pass in some extra options</a>,
so I created a <code>chef-cookbooks</code> folder under my <code>~/projects</code> to keep Chef
cookbooks, moved <code>chef-dokku</code>&rsquo;s code into <code>~/projects/chef-cookbooks/dokku</code> and
the error message changed:</p><p>That error message led me to the <code>knife.rb</code> <a href=http://docs.opscode.com/config_rb_knife.html>docs</a>
and I found out that I need to specify the <code>client_key</code> config on <code>~/.chef/knife.rb</code>
or on <code>.chef/knife.rb</code> under the project&rsquo;s root. I also found out that I could
save a few keystrokes and avoid the <code>-o</code> parameter by specifying the <code>cookbook_path</code>
option. As a result, I&rsquo;ve added my client key to <code>~/.chef/client.pem</code> and created a
<code>~/.chef/knife.rb</code> file with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>client_key <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;HOME&#39;</span><span style=color:#f92672>]</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/.chef/client.pem&#34;</span>
</span></span><span style=display:flex><span>cookbook_path <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;HOME&#39;</span><span style=color:#f92672>]</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/projects/chef-cookbooks&#34;</span></span></span></code></pre></div><p>With that in place I tried to share the Cookbook again without luck:</p><p>It turns out that knife / chef needs some folders in order to do its job. I
couldn&rsquo;t find a way to change the folder it uses so after some trial and error
I ended up creating the directories required with <code>sudo mkdir -p /var/chef/cache/checksums</code>,
<code>chown</code>ed it to my user with <code>sudo chown -R fabio: /var/chef</code> to avoid using
<code>sudo</code> and the error message changed again:</p><p>I&rsquo;ve tried to enable debug logging with <code>-l debug</code> as the error message suggests
but it didn&rsquo;t work. Looking at <code>knife -h</code> I found out that the proper way to enable
debugging is to provide <code>-VV</code> to the <code>knife</code> command and that gave me a pretty
stacktrace to look into:</p><p>Looking at that stacktrace I noticed that the <code>User-id</code> was missing and I went
off to Chef sources to find out where that should come from. Looking at <a href=https://github.com/opscode/chef/blob/56a5ae1f9b7f7d5854c6532566995d1c8a276e6e/lib/chef/knife/cookbook_site_share.rb#L67>these lines</a>
I found out that that parameter comes from the <code>node_name</code> defined on our knife
configs and I added it my <code>~/.chef/knife.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># Replace with your Opscode username</span>
</span></span><span style=display:flex><span>node_name <span style=color:#e6db74>&#34;fgrehm&#34;</span></span></span></code></pre></div><p>But that still wasn&rsquo;t enough and the error message changed one more time:</p><p>Some googling led me to <a href=https://tickets.opscode.com/browse/CHEF-4456>this issue</a>
on Chef&rsquo;s issue tracker and I found out that I had to downgrade to Ruby 1.9 as I
was using 2.0. After downgrading and installing Chef again I was finally able to
share the cookbook \o/</p><p>Summing up, here&rsquo;s what you need to share your cookbook:</p><ul><li>Ruby 1.9</li><li>Chef gem</li><li><a href="https://getchef.opscode.com/signup?ref=community">An account at Opscode</a></li><li>Make sure the cookbooks are kept on a folder with the same name as the cookbook itself (ex: <code>chef-dokku</code> should be cloned to <code>dokku</code>)</li><li><code>~/.chef/knife.rb</code> or <code>./.chef/knife.rb</code> configured with:<ul><li><code>client_key</code>: you should have seen it while registering with Opscode, if you didn&rsquo;t save it get a new one at <a href=https://www.opscode.com/account/password>https://www.opscode.com/account/password</a></li><li><code>node_name</code>: your Opscode username</li><li><code>cookbook_path</code>: this is optional and will allow you to omit the <code>-o</code> parameter when sharing your cookbooks</li></ul></li></ul><div class=related><h3>Similar articles:</h3><ul><li><a href=/blog/2013/09/11/announcing-ventriloquist/>Announcing Ventriloquist</a></li></ul></div></div></div></section><script src=/js/copycode.js></script><section class=section><div class=container><aside><div id=disqus_thread></div></aside><div id=show_comments><a id=load_comments class="button is-link">Load comments</a></div><script type=text/javascript>var disqus_shortname="fgrehm",hash;function disqus(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}hash=window.location.hash.substr(1),hash.length>8&&hash.substring(0,8)==="comment-"?(disqus(),document.getElementById("show_comments").style.display="none"):document.getElementById("load_comments").onclick=function(){disqus(),document.getElementById("show_comments").style.display="none"}</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p>&copy; <a href=https://github.com/fgrehm>Fabio Rehm</a> 2013-2022</p><p>Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/ribice/kiss>Kiss</a>.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z78MGSF72P"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z78MGSF72P",{anonymize_ip:!1})}</script></body></html>