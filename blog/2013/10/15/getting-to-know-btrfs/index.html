<!doctype html><html xmlns=http://www.w3.org/1999/xhtml><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Getting to know BTRFS | fabiorehm.com</title><meta property="og:title" content="Getting to know BTRFS - fabiorehm.com"><meta property="og:description" content="Or why lxc-clone will probably be the next &#34;big thing&#34; on vagrant-lxc"><meta property="og:url" content="https://fabiorehm.com/blog/2013/10/15/getting-to-know-btrfs/"><meta property="og:site_name" content="fabiorehm.com"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/2b78c6da27ec7e1419eebc8b683c25a3?s=256"><meta property="article:section" content="Blog"><meta property="article:tag" content="vagrant"><meta property="article:tag" content="lxc"><meta property="article:tag" content="btrfs"><meta property="article:tag" content="copy on write"><meta property="article:published_time" content="2013-10-15T00:00:00Z"><meta property="article:modified_time" content="2013-10-15T00:00:00Z"><meta name=twitter:card content="summary"><meta name=twitter:site content="@fgrehm"><meta name=twitter:creator content="@fgrehm"><link href=https://fabiorehm.com/index.xml rel=alternate type=application/rss+xml title=fabiorehm.com><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://fabiorehm.com/css/site.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://fabiorehm.com/blog/2013/10/15/getting-to-know-btrfs/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://fabiorehm.com/><h1 id=nav-heading class="title is-4">fabiorehm.com</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=email href=mailto:site@fabiorehm.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=github href=https://github.com/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=twitter href=https://twitter.com/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/fgrehm target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922H1.468748v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a><a class=level-item aria-label=rss href=/index.xml target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/vagrant/>#vagrant</a>
| <a class="subtitle is-6" href=/tags/lxc/>#lxc</a>
| <a class="subtitle is-6" href=/tags/btrfs/>#btrfs</a>
| <a class="subtitle is-6" href=/tags/copy-on-write/>#copy on write</a></div><h2 class="subtitle is-6">October 15, 2013</h2><h1 class=title>Getting to know BTRFS</h1><div class=content><p>I&rsquo;ve been playing a lot with <a href=http://docker.io>Docker</a> recently and while learning
<a href=http://docs.docker.io/en/latest/terms/layer/#layers>more about it</a> I came across
<a href=http://aufs.sourceforge.net/aufs.html>&ldquo;Another Union File System&rdquo;</a> (AUFS) + its
<a href=http://en.wikipedia.org/wiki/Copy-on-write>Copy On Write</a> (COW) capabilities and have
been pretty impressed by it. In short, by using a COW + <a href=http://en.wikipedia.org/wiki/Union_mount>union file system</a>
Docker makes things <em>really cheap</em> when it comes to disk usage.</p><p>The idea of COW filesystems along with <a href=https://github.com/dotcloud/docker/issues/443>a couple</a>
<a href=https://github.com/fgrehm/vagrant-lxc/issues/81>GitHub issues</a>, some tweets
exchanged with <a href=https://twitter.com/rcarmo>@rcarmo</a> and <a href=http://s3hh.wordpress.com/2013/05/02/lxc-improved-clone-support/>this post</a>
on improvements made on <code>lxc-clone</code> was enough to trigger my interest on <a href=https://btrfs.wiki.kernel.org/index.php/Main_Page>BTRFS</a>
and I went out to learn more about it.</p><h2 id=whats-with-copy-on-write-aka-cow>What&rsquo;s with Copy on Write (aka COW)?
<a href=#whats-with-copy-on-write-aka-cow><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>Some googling pointed me to <a href=http://faif.objectis.net/download-copy-on-write-based-file-systems>this comprehensive</a>
thesis on Copy On Write Based File Systems by Sakis Kasampalis and while I havent
read the whole thesis yet, I found this pretty nice definition about COW on
page 19:</p><blockquote><p>COW generally follows a simple principle. As long as multiple programs need
read only access to a data structure, providing them only pointers which
point to the same data structure, instead of copying the whole structure to
a new one, is enough.</p></blockquote><p>If you&rsquo;ve never heard of COW take the time to grasp those words and think about
applying that to a File System. If you can&rsquo;t get the big picture don&rsquo;t worry, just
keep reading :)</p><p>Going further, Kasampalis writes:</p><blockquote><p>If at least one of the programs needs at some point
write access to the data structure, create a private copy for it. The same holds
for each one of the programs which will need write access to the data structure.
A new private copy will be created for them.</p></blockquote><blockquote><p>Let&rsquo;s assume that we have an array data structure called &ldquo;foo&rdquo;, and two programs
called &ldquo;Bob&rdquo; and &ldquo;Alice&rdquo; which need to access it in read/write mode. If during the
access, none of the programs tries to change the contents of &ldquo;foo&rdquo;, both &ldquo;Bob&rdquo; and
&ldquo;Alice&rdquo; will actually use exactly the same &ldquo;foo&rdquo; array. If at some point &ldquo;Bob&rdquo;
changes the contents of &ldquo;foo&rdquo;, a private copy of the changed data of &ldquo;foo&rdquo; will
automatically be created by the COW system and provided to &ldquo;Bob&rdquo;. Note
that the unchanged data can still be shared between &ldquo;Bob&rdquo; and &ldquo;Alice&rdquo;. This
is a powerful feature of COW.</p></blockquote><p>He also highlights the benefits of COW file systems on page 20:</p><blockquote><p>I believe that COW&rsquo;s major contributions to file systems are the support for (1)
taking cheap snapshots, (2) ensuring both data and metadata consistency and
integrity with acceptable performance.</p></blockquote><p>As another COW example, we have <a href=http://www.rubyenterpriseedition.com/faq.html#what_is_this>Ruby Enterprise Edition</a>,
that shipped with a &ldquo;<em>copy-on-write friendly garbage collector, capable of reducing
Ruby on Rails applicationsâ€™ memory usage by 33% on average</em>&rdquo; and had its EOL
anounced once a copy-on-write patch was checked into Ruby 2.0. For other use
cases please refer to <a href=http://en.wikipedia.org/wiki/Copy-on-write#Other_applications_of_copy-on-write>Wikipedia</a>.</p><h2 id=b-tree-data-structure>B-tree data structure
<a href=#b-tree-data-structure><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>If you forgot about your data structure lessons, here&rsquo;s the definition from <a href=http://en.wikipedia.org/wiki/B-tree>Wikipedia</a>:</p><blockquote><p>In computer science, a B-tree is a tree data structure that keeps data sorted and
allows searches, sequential access, insertions, and deletions in logarithmic time.
The B-tree is a generalization of a binary search tree in that a node can have more
than two children. (Comer 1979, p. 123) Unlike self-balancing binary search trees,
the B-tree is optimized for systems that read and write large blocks of data.
It is commonly used in databases and filesystems.</p></blockquote><h2 id=b-tree-file-system-aka-btrfs>B-tree file system (aka BTRFS)
<a href=#b-tree-file-system-aka-btrfs><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>From <a href=http://en.wikipedia.org/wiki/Btrfs>Wikipedia</a> again:</p><blockquote><p>Btrfs [&mldr;] is a GPL-licensed experimental copy-on-write file system for Linux.
[&mldr;] Btrfs is intended to address the lack of pooling, snapshots, checksums
and integral multi-device spanning in Linux file systems, these features being
crucial as Linux use scales upward into the larger storage configurations common
in enterprise. Chris Mason, the principal Btrfs author, has stated that its goal
was &ldquo;to let Linux scale for the storage that will be available. Scaling is not
just about addressing the storage but also means being able to administer and
to manage it with a clean interface that lets people see what&rsquo;s being used and
makes it more reliable.&rdquo;</p></blockquote><p>Although it looks pretty exciting from outside when you play with it, there are
some things to keep in mind:</p><blockquote><p>It is still in heavy development and marked as unstable. Especially when the
filesystem becomes full, no-space conditions arise which might make it
challenging to delete files.</p></blockquote><h2 id=trying-it-out-aka-what-it-means-for-vagrant-lxc>Trying it out (aka &ldquo;What it means for vagrant-lxc?&rdquo;)
<a href=#trying-it-out-aka-what-it-means-for-vagrant-lxc><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>Enough theory and copy and pasting! Because an <a href=http://asciinema.org/>asciicast</a> is
worth more than a thousand words, check out the one below. I used the <code>quantal</code>
machine from <a href=https://github.com/fgrehm/vagrant-lxc-vbox-hosts>vagrant-lxc-vbox-hosts</a>
to fire up a VBox machine ready to rock and recorded the asciicast from there.</p><p>I hope I gave you enough reason to watch the asciicast with the information above
but if you ended up not watching it, I&rsquo;d just like to let you know that I was able
to &ldquo;break&rdquo; one of the most basic Physics law that states that two things cannot occupy
the same space at the same time by using <a href=https://help.ubuntu.com/lts/serverguide/lxc.html#lxc-cloning><code>lxc-clone</code> and its snapshotting capabilities</a>
:P Thanks to BTRFS I was capable of fitting <strong>22 GB</strong> of data into just <strong>405MB</strong>!</p><p>So, can you guess what does that mean for vagrant-lxc? Basically even faster container
creation times (under 0.1 millisecond for <code>lxc-clone</code> + BTRFS snapshotting) and lower
disk usage. This also means that support for vagrant-lxc container <a href=https://github.com/fgrehm/vagrant-lxc/issues/32>snapshots</a>
should be <em>easier</em> to implement once the cloning functionality is in place.</p><h2 id=thats-awesome-i-want-it-now>That&rsquo;s awesome! I want it now!
<a href=#thats-awesome-i-want-it-now><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>Well&mldr; Unfortunately I&rsquo;m not sure when this is going to be easily supported from
vagrant-lxc, so for now you&rsquo;ll need to do things by hand. Please check the asciicast
in order to find out how to set things up and to &ldquo;trick&rdquo; vagrant-lxc into using your
cloned containers.</p><p>One thing that I know for sure is that we&rsquo;ll have to wait for Vagrant 1.4 because
of <a href=https://github.com/mitchellh/vagrant/pull/2327>this pull request</a> which enables
us to <a href=https://github.com/mitchellh/vagrant/pull/2327/files#diff-5d84fa7a300da3b9958d69831795c066R49>hook</a>
into Vagrant&rsquo;s process of removing base boxes. The reason behind that is that
we&rsquo;ll need to keep a &ldquo;base container&rdquo; around in order to create our lxc clones
from and without that we are not able to automatically delete the base
container rootfs in case the user removes a vagrant-lxc base box, leaving
unused containers behind.</p><p>On a side note, I&rsquo;ve had some trouble using <code>lxc-clone</code> with vagrant-lxc containers
on both an Ubuntu 13.04 VBox VM and my own laptop so I had to switch back to a
12.10 VM in order to record the asciicast. I haven&rsquo;t had the chance to find out
what&rsquo;s going on yet <a href=http://s3hh.wordpress.com/2013/05/02/lxc-improved-clone-support/#comment-902>but it seems that I&rsquo;m not the only one having trouble with it</a>.</p><p>To finish this up, I want to make clear that I&rsquo;ve only done some initial experiments
with BTRFS and I have no idea how it behaves on the wild but I&rsquo;ll definitely look into
adding some experimental support for <code>lxc-clone</code> in a future vagrant-lxc version. I&rsquo;m
not really sure how that will look like but on the spirit of eating my own dog food
I&rsquo;ll try to create a BTRFS partition on my physical HD soon as a start see how it goes :)</p><div class=related><h3>Similar articles:</h3><ul><li><a href=/blog/2013/10/13/ventriloquist-demo/>Ventriloquist demo</a></li><li><a href=/blog/2013/09/11/announcing-ventriloquist/>Announcing Ventriloquist</a></li><li><a href=/blog/2013/07/18/crafting-your-own-vagrant-lxc-base-box/>Crafting your own vagrant-lxc base box</a></li><li><a href=/blog/2013/06/10/improving-vagrant-lxc-boxes/>Improving vagrant-lxc boxes</a></li><li><a href=/blog/2013/04/28/lxc-provider-for-vagrant/>LXC provider for Vagrant</a></li></ul></div></div></div></section><section class=section><div class=container><aside><div id=disqus_thread></div></aside><div id=show_comments><a id=load_comments class="button is-link">Load comments</a></div><script type=text/javascript>var disqus_shortname="fgrehm",hash;function disqus(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}hash=window.location.hash.substr(1),hash.length>8&&hash.substring(0,8)==="comment-"?(disqus(),document.getElementById("show_comments").style.display="none"):document.getElementById("load_comments").onclick=function(){disqus(),document.getElementById("show_comments").style.display="none"}</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p>&copy; <a href=https://github.com/fgrehm>Fabio Rehm</a> 2013-2022</p><p>Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/ribice/kiss>Kiss</a>.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z78MGSF72P"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z78MGSF72P",{anonymize_ip:!1})}</script></body></html>