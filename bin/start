#!/bin/bash
#
# Start blog development environment
# - Hugo server (localhost:1313)
# - Auto-commit loop for drafts (every 10 minutes)
# - clone drafts
#

set -e

PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
BIN_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# PIDs for cleanup
HUGO_PID=""
AUTOCOMMIT_PID=""

# Cleanup on exit
cleanup() {
  echo ""
  echo -e "${YELLOW}Shutting down services...${NC}"

  if [ -n "$HUGO_PID" ]; then
    echo "  Stopping Hugo server (PID $HUGO_PID)"
    kill $HUGO_PID 2>/dev/null || true
  fi

  if [ -n "$AUTOCOMMIT_PID" ]; then
    echo "  Stopping auto-commit loop (PID $AUTOCOMMIT_PID)"
    kill $AUTOCOMMIT_PID 2>/dev/null || true
  fi

  echo -e "${GREEN}‚úì All services stopped${NC}"
}

trap cleanup EXIT INT TERM

# Banner
echo "================================================"
echo "üöÄ Starting fabiorehm.com dev environment"
echo "================================================"
echo ""

# 0. Ensure git submodules are initialized (e.g. hugo-coder theme)
if [ -f "$PROJECT_ROOT/.gitmodules" ] && [ -z "$(ls -A "$PROJECT_ROOT/themes/hugo-coder" 2>/dev/null)" ]; then
  echo -e "${YELLOW}Theme submodule not initialized. Running git submodule update --init...${NC}"
  git submodule update --init
  echo -e "  ${GREEN}‚úì Submodules initialized${NC}"
  echo ""
fi

# 0.5. Clone drafts repo if not present
DRAFTS_DIR="$PROJECT_ROOT/content/en/drafts"
if [ ! -d "$DRAFTS_DIR/.git" ]; then
  echo -e "${YELLOW}Drafts repo not found. Cloning...${NC}"
  if git clone git@github.com:fgrehm/blog-drafts.git "$DRAFTS_DIR" 2>/dev/null; then
    echo -e "  ${GREEN}‚úì Drafts repo cloned${NC}"
  else
    echo -e "  ${YELLOW}‚ö† Could not clone drafts repo (no access or offline). Skipping.${NC}"
  fi
  echo ""
fi

# 0.6. Verify Hugo Extended is available (required for SCSS)
if ! hugo version 2>/dev/null | grep -q '+extended'; then
  echo -e "${RED}ERROR: Hugo Extended is required but not installed.${NC}"
  echo "  Your version: $(hugo version 2>/dev/null || echo 'hugo not found')"
  echo "  The hugo-coder theme needs SCSS support from Hugo Extended."
  echo ""
  echo "  Install options:"
  echo "    snap:  sudo snap install hugo --channel=extended"
  echo "    brew:  brew install hugo  (extended by default)"
  echo "    other: https://github.com/gohugoio/hugo/releases (download hugo_extended_*)"
  exit 1
fi

# 1. Start Hugo server
echo -e "${GREEN}[1/2]${NC} Starting Hugo server..."
hugo server -D &
HUGO_PID=$!
echo "  ‚úì Hugo running on http://localhost:1313 (PID $HUGO_PID)"

# 2. Start auto-commit loop for drafts
echo -e "${GREEN}[2/2]${NC} Starting drafts auto-commit loop (every 10 minutes)..."
(
  while true; do
    sleep 600 # 10 minutes
    echo -e "${YELLOW}[$(date +%H:%M:%S)]${NC} Running drafts auto-commit..."
    "$BIN_DIR/drafts-autocommit"
  done
) &
AUTOCOMMIT_PID=$!
echo "  ‚úì Auto-commit scheduled (PID $AUTOCOMMIT_PID)"

echo ""
echo "================================================"
echo -e "${GREEN}‚úì All services running${NC}"
echo "================================================"
echo ""
echo "  üè† Blog:          http://localhost:1313/"
echo "  üìù Drafts:        http://localhost:1313/drafts/"
echo "  üìì Notes:         http://localhost:1313/notes/"
echo ""
echo "  Auto-commit: Every 10 minutes"
echo "  Manual commit: bin/drafts-autocommit"
echo ""
echo "  Press Ctrl+C to stop all services"
echo ""

# Wait for any process to exit
wait
